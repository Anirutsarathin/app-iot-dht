#include <WiFi.h>
#include <Firebase_ESP_Client.h>
#include <DHT.h>
#include <ArduinoJson.h>
#include <time.h>

// **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• WiFi**
#define WIFI_SSID "A."
#define WIFI_PASSWORD "Anirut11"

// **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firebase**
#define API_KEY "AIzaSyCXFFSQmSMYJ5zlDx2kZ2ze8qFqQsVtF9o"
#define FIREBASE_PROJECT_ID "dht22-5fa21"
#define FIREBASE_URL "https://firestore.googleapis.com/v1/projects/dht22-5fa21/databases/(default)/documents/"

// **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Firebase Authentication**
#define USER_EMAIL "anirut.rstar@gmail.com"
#define USER_PASSWORD "1849901455899"

// **‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏û‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á DHT22**
#define DHTPIN 2
#define DHTTYPE DHT22
DHT dht(DHTPIN, DHTTYPE);

// **‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡πá‡∏≠‡∏ö‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå Firebase**
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

// **‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Time Server ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ (UTC+7)**
const char* ntpServer = "pool.ntp.org";
const long  gmtOffset_sec = 7 * 3600;  // UTC+7
const int   daylightOffset_sec = 0;

void setup() {
  Serial.begin(115200);

  // **‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wi-Fi**
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Connecting to Wi-Fi");

  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(1000);
  }
  Serial.println("\n‚úÖ Connected to Wi-Fi");

  // **‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase**
  config.api_key = API_KEY;
  auth.user.email = USER_EMAIL;
  auth.user.password = USER_PASSWORD;

  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  dht.begin();

  // **‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤**
  configTime(gmtOffset_sec, daylightOffset_sec, ntpServer);
}

void loop() {
  // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå DHT22
  float T = dht.readTemperature();
  if (isnan(T)) {
    Serial.println("‚ùå No Detect Sensor");
    return;
  }

  // **‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏∏‡πà‡∏°**
  float Tg = random(30, 36);  // ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡πà‡∏≤ Tg = 30-35
  float Tw = random(40, 46);  // ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡πà‡∏≤ Tw = 40-45

  // **‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô**
  struct tm timeinfo;
  if (!getLocalTime(&timeinfo)) {
    Serial.println("‚ùå Failed to obtain time");
    return;
  }

  char dateStr[11];  // YYYY-MM-DD
  char timeStr[9];   // HH:MM:SS
  char dateTimeStr[20]; // YYYY-MM-DD_HH-MM-SS
  strftime(dateStr, sizeof(dateStr), "%Y-%m-%d", &timeinfo);
  strftime(timeStr, sizeof(timeStr), "%H:%M:%S", &timeinfo);
  strftime(dateTimeStr, sizeof(dateTimeStr), "%Y-%m-%d_%H-%M-%S", &timeinfo);

  // **‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Serial Monitor**
  Serial.print("üå° Temperature: ");
  Serial.print(T);
  Serial.println("¬∞C");

  Serial.print("üî• Tg (Random): ");
  Serial.print(Tg);
  Serial.println("¬∞C");

  Serial.print("üí¶ Tw (Random): ");
  Serial.print(Tw);
  Serial.println("¬∞C");

  Serial.print("üìÖ Date: ");
  Serial.println(dateStr);

  Serial.print("‚è∞ Time: ");
  Serial.println(timeStr);

  // **‡∏™‡∏£‡πâ‡∏≤‡∏á JSON object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firestore**
  FirebaseJson json;
  json.set("fields/T/doubleValue", T);
  json.set("fields/Tg/doubleValue", Tg);
  json.set("fields/Tw/doubleValue", Tw);
  json.set("fields/date/stringValue", dateStr);  // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤
  json.set("fields/time/stringValue", timeStr);  // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤

  // **‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á**
  String documentPath = "sensor/history/" + String(dateTimeStr);

  // **‡πÉ‡∏ä‡πâ createDocument() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á**
  if (Firebase.Firestore.createDocument(&fbdo, FIREBASE_PROJECT_ID, "", documentPath.c_str(), json.raw())) {
    Serial.println("‚úÖ Data added to Firestore history!");
  } else {
    Serial.println("‚ùå Failed to save data: " + fbdo.errorReason());
  }

  delay(10000);  // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
}

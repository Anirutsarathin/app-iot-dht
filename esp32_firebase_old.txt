#include <WiFi.h>
#include <Firebase_ESP_Client.h>
#include <DHT.h>
#include <ArduinoJson.h>

// **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• WiFi**
#define WIFI_SSID "A."
#define WIFI_PASSWORD "Anirut11"

// **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firebase**
#define API_KEY "AIzaSyCXFFSQmSMYJ5zlDx2kZ2ze8qFqQsVtF9o"
#define FIREBASE_PROJECT_ID "dht22-5fa21"
#define FIREBASE_URL "https://firestore.googleapis.com/v1/projects/dht22-5fa21/databases/(default)/documents/"

// **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Firebase Authentication**
#define USER_EMAIL "anirut.rstar@gmail.com"
#define USER_PASSWORD "1849901455899"

// **‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏û‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á DHT22**
#define DHTPIN 2
#define DHTTYPE DHT22
DHT dht(DHTPIN, DHTTYPE);

// **‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡πá‡∏≠‡∏ö‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå Firebase**
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

void setup() {
  Serial.begin(115200);

  // **‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wi-Fi**
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Connecting to Wi-Fi");

  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(1000);
  }
  Serial.println("\n‚úÖ Connected to Wi-Fi");

  // **‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase**
  config.api_key = API_KEY;
  auth.user.email = USER_EMAIL;
  auth.user.password = USER_PASSWORD;

  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  dht.begin();
}

void loop() {
  // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå
  float humidity = dht.readHumidity();
  float temperature = dht.readTemperature();

  if (isnan(humidity) || isnan(temperature)) {
    Serial.println("‚ùå No Detect Sensor");
    return;
  }

  Serial.print("üå° Temperature: ");
  Serial.print(temperature);
  Serial.println("¬∞C");

  Serial.print("üíß Humidity: ");
  Serial.print(humidity);
  Serial.println("%");

  // **‡∏™‡∏£‡πâ‡∏≤‡∏á JSON object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firestore**
  FirebaseJson json;
  json.set("fields/temperature/doubleValue", temperature);
  json.set("fields/humidity/doubleValue", humidity);
  json.set("fields/timestamp/integerValue", millis());

  // **‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô Firestore**
  String documentPath = "sensor/latest";  // Collection: sensor, Document: latest
  String requestURL = String(FIREBASE_URL) + documentPath + "?key=" + API_KEY;

  // **‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô patchDocument() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°**
  if (Firebase.Firestore.patchDocument(&fbdo, FIREBASE_PROJECT_ID, "", documentPath.c_str(), json.raw(), "")) {
    Serial.println("‚úÖ Data updated in Firestore!");
  } else {
    Serial.println("‚ùå Failed to update data: " + fbdo.errorReason());
  }

  delay(5000);  // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
}
